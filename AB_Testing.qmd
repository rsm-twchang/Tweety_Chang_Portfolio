---
title: A Replication of Karlan and List (2007)
author: Tweety
date: Apr 22, 2025
lang: en
callout-appearance: minimal
theme:
  - cosmo
  - brand

# disable execution for this page
execute:
  enabled: false

# any other metadata you already have
document-css: false
link-citations: true
---


## Introduction

Dean Karlan at Yale and John List at the University of Chicago conducted a field experiment to test the effectiveness of different fundraising letters. They sent out 50,000 fundraising letters to potential donors, randomly assigning each letter to one of three treatments: a standard letter, a matching grant letter, or a challenge grant letter. They published the results of this experiment in the _American Economic Review_ in 2007. The article and supporting data are available from the [AEA website](https://www.aeaweb.org/articles?id=10.1257/aer.97.5.1774) and from Innovations for Poverty Action as part of [Harvard's Dataverse](https://dataverse.harvard.edu/dataset.xhtml?persistentId=doi:10.7910/DVN/27853&version=4.2).
---


## Objective

The objective of this assignment is to replicate and interpret the findings from Karlan and List’s 2007 field experiment on charitable giving. Using the original dataset, I aim to explore how the presence and structure of a matching donation offer affects both the likelihood and amount of charitable contributions.

This project involves:

- Analyzing treatment effects using t-tests, regression models, and probit analysis
- Comparing donation behavior across different match ratios and suggested ask levels
- Conducting simulations to illustrate the Law of Large Numbers and the Central Limit Theorem
- Presenting results in a clear, reproducible format using Quarto and Python

The overall goal is to better understand the behavioral response to charitable incentives and how small changes in message framing can impact donor behavior.
---


## Description of the Experiment

In their 2007 study published in the *American Economic Review*, Dean Karlan and John List conducted a large-scale natural field experiment to test the effectiveness of matching donations in a real-world fundraising campaign. Over 50,000 previous donors to a U.S. nonprofit were mailed fundraising letters and randomly assigned to one of two groups:

- *Control group:* received a standard fundraising letter with no special offer
- *Treatment group:* received a similar letter but was offered a matching donation, meaning their contribution would be matched by another donor

Within the treatment group, individuals were further randomized into subgroups based on:

- *Match ratio:* $1\!:\!1$, $2\!:\!1$, or $3\!:\!1$
- *Maximum match amount:* $25{,}000$, $50{,}000$, $100{,}000$, or unstated
- *Suggested donation amount:* equal to 1.25× or 1.5× the donor’s previous contribution

The randomized design allows for causal analysis of how these variations influence both the decision to donate and the amount given. This experiment provides a powerful example of how field experiments can be used to study economic behavior in natural settings.
---


## Data Description
We begin by loading the dataset provided by Karlan and List (2007), which contains detailed records from their fundraising field experiment.
```{python}
#| echo: false
import pandas as pd

df = pd.read_stata("karlan_list_2007.dta")
df.head()
```

:::: {.callout-note collapse="true"}
### Variable Definitions

| Variable             | Description                                                         |
|----------------------|---------------------------------------------------------------------|
| `treatment`          | Treatment                                                           |
| `control`            | Control                                                             |
| `ratio`              | Match ratio                                                         |
| `ratio2`             | 2:1 match ratio                                                     |
| `ratio3`             | 3:1 match ratio                                                     |
| `size`               | Match threshold                                                     |
| `size25`             | \$25,000 match threshold                                            |
| `size50`             | \$50,000 match threshold                                            |
| `size100`            | \$100,000 match threshold                                           |
| `sizeno`             | Unstated match threshold                                            |
| `ask`                | Suggested donation amount                                           |
| `askd1`              | Suggested donation was highest previous contribution                |
| `askd2`              | Suggested donation was 1.25 x highest previous contribution         |
| `askd3`              | Suggested donation was 1.50 x highest previous contribution         |
| `ask1`               | Highest previous contribution (for suggestion)                      |
| `ask2`               | 1.25 x highest previous contribution (for suggestion)               |
| `ask3`               | 1.50 x highest previous contribution (for suggestion)               |
| `amount`             | Dollars given                                                       |
| `gave`               | Gave anything                                                       |
| `amountchange`       | Change in amount given                                              |
| `hpa`                | Highest previous contribution                                       |
| `ltmedmra`           | Small prior donor: last gift was less than median \$35              |
| `freq`               | Number of prior donations                                           |
| `years`              | Number of years since initial donation                              |
| `year5`              | At least 5 years since initial donation                             |
| `mrm2`               | Number of months since last donation                                |
| `dormant`            | Already donated in 2005                                             |
| `female`             | Female                                                              |
| `couple`             | Couple                                                              |
| `state50one`         | State tag: 1 for one observation of each of 50 states; 0 otherwise  |
| `nonlit`             | Nonlitigation                                                       |
| `cases`              | Court cases from state in 2004-5 in which organization was involved |
| `statecnt`           | Percent of sample from state                                        |
| `stateresponse`      | Proportion of sample from the state who gave                        |
| `stateresponset`     | Proportion of treated sample from the state who gave                |
| `stateresponsec`     | Proportion of control sample from the state who gave                |
| `stateresponsetminc` | stateresponset - stateresponsec                                     |
| `perbush`            | State vote share for Bush                                           |
| `close25`            | State vote share for Bush between 47.5% and 52.5%                   |
| `red0`               | Red state                                                           |
| `blue0`              | Blue state                                                          |
| `redcty`             | Red county                                                          |
| `bluecty`            | Blue county                                                         |
| `pwhite`             | Proportion white within zip code                                    |
| `pblack`             | Proportion black within zip code                                    |
| `page18_39`          | Proportion age 18-39 within zip code                                |
| `ave_hh_sz`          | Average household size within zip code                              |
| `median_hhincome`    | Median household income within zip code                             |
| `powner`             | Proportion house owner within zip code                              |
| `psch_atlstba`       | Proportion who finished college within zip code                     |
| `pop_propurban`      | Proportion of population urban within zip code                      |

::::

```{python}
#| echo: false
# Basic treatment/control breakdown
print("Unique match ratios:", df["ratio"].unique())
print("Treatment group size:", df[df["treatment"] == 1].shape[0])
print("Control group size:", df[df["treatment"] == 0].shape[0])
```
```{python}
#| echo: false
# Summary statistics: mean donation rate and average donation by group
summary = df.groupby("treatment")[["gave", "amount"]].agg(['mean', 'count']).round(4)
summary
```

### Summary Statistics by Treatment Status

```{python}
#| echo: false
import pandas as pd
import matplotlib.pyplot as plt

# Build a small summary table from your output
summary = pd.DataFrame({
    "Group": ["Control", "Treatment"],
    "Donation rate": [0.0179, 0.0220],
    "Avg donation": [0.8133, 0.9669],
    "n": [16687, 33396]
})

# --- Chart 1: Donation rate ---
plt.figure(figsize=(7,4))
colors = ["#4C72B0", "#DD8452"]  
plt.bar(summary["Group"], summary["Donation rate"], color=colors)
plt.ylabel("Donation rate", fontsize=10)
plt.title("Donation Rate by Group", fontsize=10)

plt.tick_params(axis="x", labelsize=11, pad=6)
plt.tick_params(axis="y", labelsize=11, pad=6)

for i, row in summary.iterrows():
    plt.text(
        i,
        row["Donation rate"],
        f'{row["Donation rate"]*100:.2f}%\n(n={row["n"]:,})',
        ha="center",
        va="bottom",
        fontsize=10
    )

plt.tight_layout()
plt.show()

# --- Chart 2: Average donation amount ---
plt.figure(figsize=(7,4))
colors = ["#4C72B0", "#DD8452"]  
plt.bar(summary["Group"], summary["Avg donation"], color=colors)
plt.ylabel("Average donation amount ($)", fontsize=10)
plt.title("Average Donation Amount by Group", fontsize=10)

plt.tick_params(axis="x", labelsize=11, pad=6)
plt.tick_params(axis="y", labelsize=11, pad=6)


for i, row in summary.iterrows():
    plt.text(
        i,
        row["Avg donation"],
        f'${row["Avg donation"]:.2f}\n(n={row["n"]:,})',
        ha="center",
        va="bottom",
        fontsize=10
    )

plt.tight_layout()
plt.show()
```

**Figure 1. Donation Rate by Group**
![Donation Rate by Group](figures/fig1_donation_rate_by_group.png){#fig-donation-rate}

The treatment group has a higher donation rate (2.20%) than the control group (1.79%). Sample sizes are shown above each bar.

**Figure 2. Average Donation Amount by Group**
![Average Donation Amount by Group](figures/fig2_avg_donation_amount.png){#fig-avg-donation}

Average donations, including non-donors, are higher in the treatment group ($0.97) than in the control group ($0.81), suggesting that the matching offer increased total giving on average. Sample sizes are shown above each bar.

## Balance Test 
To assess whether the randomization produced comparable treatment and control groups, we tested balance on several pre-treatment characteristics: months since last donation (mrm2), years since first donation, number of prior donations (freq), and a gender indicator (female).

### T-Test and Linear Regression for Each Variable
```{python}
#| echo: false
from scipy.stats import ttest_ind
import statsmodels.formula.api as smf

def balance_test(var):
    subset = df[['treatment', var]].dropna()
    
    # T-test
    treated = subset[subset['treatment'] == 1][var]
    control = subset[subset['treatment'] == 0][var]
    t_stat, p_val = ttest_ind(treated, control, equal_var=False)
    print(f"\nT-test for {var}: t = {t_stat:.3f}, p = {p_val:.4f}")
    
    # Linear regression
    model = smf.ols(f'{var} ~ treatment', data=subset).fit()
    print(model.summary().tables[1])  # Coefficient table

# Run for selected baseline variables
for var in ['mrm2', 'years', 'freq', 'female']:
    balance_test(var)
```

| Variable | Treatment Coefficient | p-value |
|--------|----------------------|---------|
| mrm2   | 0.0137               | 0.905   |
| years  | −0.0575              | 0.270   |
| freq   | −0.0120              | 0.912   |
| female | −0.0075              | 0.079   |

None of the estimated treatment effects are statistically significant at the 5% level, indicating balance across observable characteristics. These results are consistent with the balance checks reported in Table 1 of Karlan and List (2007).

### Balance Check for mrm2

| Statistic                     | Value   |
|-------------------------------|---------|
| Treatment coefficient         | 0.0137  |
| p-value (t-test)              | 0.9049  |
| p-value (regression)          | 0.9050  |
| 95% confidence interval       | [−0.211, 0.238] |

```{python}
#| echo: false
# Drop NA for mrm2
balance_df = df[['treatment', 'mrm2']].dropna()

# T-TEST 
treated = balance_df[balance_df['treatment'] == 1]['mrm2']
control = balance_df[balance_df['treatment'] == 0]['mrm2']
t_stat, p_val = ttest_ind(treated, control, equal_var=False)
print(f"T-test for mrm2: t = {t_stat:.3f}, p = {p_val:.4f}")
# LINEAR REGRESSION 
model = smf.ols('mrm2 ~ treatment', data=balance_df).fit()
print(model.summary().tables[1])  # Show only coefficient table
```

The estimated difference in months since last donation between treatment and control groups is small and statistically insignificant, indicating comparable donation recency prior to treatment.

### Additional Balance Tests
```{python}
#| echo: false
def run_balance_test(var):
    subset = df[['treatment', var]].dropna()
    
    # T-test
    treated = subset[subset['treatment'] == 1][var]
    control = subset[subset['treatment'] == 0][var]
    t_stat, p_val = ttest_ind(treated, control, equal_var=False)
    print(f"\nT-test for {var}: t = {t_stat:.3f}, p = {p_val:.4f}")
    
    # Regression
    model = smf.ols(f'{var} ~ treatment', data=subset).fit()
    print(model.summary().tables[1])  # Coefficient summary only

# Run tests for mrm2, years, freq, and female
for variable in ['mrm2', 'years', 'freq', 'female']:
    run_balance_test(variable)
```

### Balance Test — Key Estimates

| Variable | Treatment coef | t-stat | p-value | 95% CI |
|---------:|--------------:|-------:|--------:|:------:|
| mrm2     |  0.0137       |  0.119 | 0.905   | [-0.211, 0.238] |
| years    | −0.0575       | −1.103 | 0.270   | [-0.160, 0.045] |
| freq     | −0.0120       | −0.111 | 0.912   | [-0.224, 0.200] |
| female   | −0.0075       | −1.758 | 0.079   | [-0.016, 0.001] |

None of the estimated treatment effects are statistically significant at the 5% level; the gender indicator is borderline (p = 0.079) but the estimated difference is small.
---


## Experimental Results

**Figure 3. Donation Rate by Treatment Status**
![Donation Rate by Treatment Status](figures/fig3_donation_rate_treatment.png){#fig-donation-rate}

The treatment group exhibits a higher donation rate than the control group (2.20% vs. 1.79%). The difference is statistically significant at the 1% level.
```{python}
#| echo: false
import pandas as pd
import matplotlib.pyplot as plt

summary = pd.DataFrame({
    "Group": ["Control", "Treatment"],
    "Donation rate": [0.0179, 0.0220],
    "Avg donation": [0.8133, 0.9669],
    "n": [16687, 33396]
})

plt.figure(figsize=(6,4))

# set colors explicitly
colors = ["#4C72B0", "#DD8452"]  # muted blue, muted orange

plt.bar(summary["Group"], summary["Donation rate"], color=colors)

plt.ylabel("Donation rate", fontsize=11)
plt.xlabel("Group", fontsize=11)
plt.title("Donation Rate by Group", fontsize=13)
plt.ylim(0, 0.025)

for i, row in summary.iterrows():
    plt.text(
        i,
        row["Donation rate"],
        f'{row["Donation rate"]*100:.2f}%\n(n={row["n"]:,})',
        ha="center",
        va="bottom",
        fontsize=10
    )

plt.tight_layout()
plt.show()
```

### Treatment Effect on Donation Rates
We estimate the effect of the matching donation treatment on the probability of giving using both a two-sample t-test and a bivariate linear regression. Both approaches indicate a statistically significant difference in donation rates between the treatment and control groups.

The regression results imply that assignment to the treatment increases the probability of donating by approximately 0.42 percentage points (p = 0.002). Relative to the control group’s donation rate of about 1.8%, this corresponds to a roughly 22% increase in the likelihood of giving.

Although the absolute effect is small, the estimate is precise and consistent across methods, indicating that offering a matching donation increases participation in charitable giving.
```{python}
#| echo: false
# T-TEST 
control = df[df['treatment'] == 0]['gave']
treatment = df[df['treatment'] == 1]['gave']
t_stat, p_val = ttest_ind(treatment, control, equal_var=False)
print(f"T-test result: t = {t_stat:.3f}, p = {p_val:.4f}")
# BIVARIATE REGRESSION 
model = smf.ols('gave ~ treatment', data=df).fit()
print(model.summary().tables[1])  # Show coefficient table
```

| Outcome: Donated (gave) | Estimate | p-value | 95% Confidence Interval |
|-------------------------|----------|---------|-------------------------|
| Treatment effect        | 0.0042   | 0.002   | [0.002, 0.007]          |


### Probit Regression
As a robustness check for the binary outcome, we estimate a Probit model and report the average marginal effect. The treatment increases the probability of donating by 0.43 percentage points (p = 0.002), which closely matches the linear probability model estimate.


```{python}
#| echo: false
import statsmodels.api as sm
# Prepare the data
probit_df = df[['gave', 'treatment']].dropna()
X = sm.add_constant(probit_df['treatment'])  # add intercept
y = probit_df['gave']
# Run Probit model
probit_model = sm.Probit(y, X).fit()
print(probit_model.summary())

# Compute average marginal effects (AME)
marginal_effects = probit_model.get_margeff(at='overall')
print(marginal_effects.summary())
```

| Model | Effect on Pr(Donate) | p-value | 95% CI |
|------|-----------------------|---------|--------|
| Probit (AME) | 0.0043 | 0.002 | [0.002, 0.007] |

------


## Differences between Match Rates

We examine whether larger match ratios within the treatment group lead to higher donation rates by comparing 1:1, 2:1, and 3:1 matching offers. Pairwise t-tests indicate no statistically significant differences in donation rates across match ratios.

Relative to a 1:1 match, increasing the ratio to 2:1 raises the donation rate by approximately 0.19 percentage points (p = 0.335), while moving from 2:1 to 3:1 increases the rate by only 0.01 percentage points (p = 0.310). Neither difference is statistically significant.

These results suggest that higher match ratios do not meaningfully increase participation beyond the presence of a match itself, consistent with the findings in Karlan and List (2007).
```{python}
#| echo: false
from scipy.stats import ttest_ind
# Filter treatment group only
treat_only = df[df['treatment'] == 1].copy()
# Ensure ratio is numeric
treat_only['ratio'] = pd.to_numeric(treat_only['ratio'], errors='coerce')
# Extract 'gave' for each group
gave_r1 = treat_only[treat_only['ratio'] == 1]['gave']
gave_r2 = treat_only[treat_only['ratio'] == 2]['gave']
gave_r3 = treat_only[treat_only['ratio'] == 3]['gave']
# Run t-tests
_, pval_12 = ttest_ind(gave_r1, gave_r2, equal_var=False)
_, pval_13 = ttest_ind(gave_r1, gave_r3, equal_var=False)

print(f"p-value (2:1 vs 1:1): {pval_12:.4f}")
print(f"p-value (3:1 vs 1:1): {pval_13:.4f}")
```

| Comparison | Change in Donation Rate (pp) | p-value |
|-----------|-------------------------------|---------|
| 2:1 vs 1:1 | +0.19 | 0.335 |
| 3:1 vs 2:1 | +0.01 | 0.310 |
------

### Effect of Match Ratio on Donation Rates

```{python}
#| echo: false
import statsmodels.formula.api as smf
# Filter treatment group only
treat_df = df[df['treatment'] == 1].copy()
# Run regression: 1:1 is the omitted category
model = smf.ols('gave ~ ratio2 + ratio3', data=treat_df).fit()
print(model.summary().tables[1])  # Show coefficient summary
```

| Match Ratio | Change in Donation Rate (pp) | p-value |
|------------|-------------------------------|---------|
| 2:1 vs 1:1 | +0.19 | 0.338 |
| 3:1 vs 1:1 | +0.20 | 0.313 |
------


### Donation Rates by Match Ratio

Among treated individuals, donation rates are similar across match ratios. The response rate is 2.07% under a 1:1 match, 2.26% under a 2:1 match, and 2.27% under a 3:1 match.

The increase in donation rates beyond a 1:1 match is small—0.19 percentage points for a 2:1 match and 0.01 percentage points for a 3:1 match—and not statistically significant, consistent with the formal tests reported earlier. This pattern aligns with the findings of Karlan and List (2007), which show that increasing the match ratio does not materially increase participation once a match is offered.
```{python}
#| echo: false
# Filter treatment group only
treat_df = df[df['treatment'] == 1].copy()
# Convert ratio to numeric
treat_df['ratio'] = pd.to_numeric(treat_df['ratio'], errors='coerce')
# Calculate mean donation rate for each match ratio
response_rates = treat_df.groupby('ratio')['gave'].mean().round(4)
print("Average Donation Rates by Match Ratio:")
print(response_rates)
# Calculate differences
diff_2_vs_1 = response_rates[2] - response_rates[1]
diff_3_vs_2 = response_rates[3] - response_rates[2]

print(f"\nDifference (2:1 vs 1:1): {diff_2_vs_1:.4f}")
print(f"Difference (3:1 vs 2:1): {diff_3_vs_2:.4f}")
```

| Match Ratio | Donation Rate |
|------------|---------------|
| 1:1        | 0.0207 (2.07%) |
| 2:1        | 0.0226 (2.26%) |
| 3:1        | 0.0227 (2.27%) |
------


### Donation Amount
We next examine whether the matching donation treatment affects the amount donated among individuals who chose to give, focusing on the intensive margin of charitable giving.

A two-sample t-test and a linear regression both estimate a small difference in donation amounts between treatment and control donors; however, the effects are not statistically significant at conventional levels (p ≈ 0.06). The estimated magnitudes are modest.

Overall, these results suggest that while offering a matching donation increases participation, it does not meaningfully affect the amount donated conditional on giving.

```{python}
#| echo: false
from scipy.stats import ttest_ind
import statsmodels.formula.api as smf
# Prepare data
control_amt = df[df['treatment'] == 0]['amount']
treatment_amt = df[df['treatment'] == 1]['amount']
# T-TEST 
t_stat, p_val = ttest_ind(treatment_amt, control_amt, equal_var=False)
print(f"T-test result: t = {t_stat:.3f}, p = {p_val:.4f}")

#  REGRESSION 
model = smf.ols('amount ~ treatment', data=df).fit()
print(model.summary().tables[1])
```


### Distribution of Donation Amounts Among Donors

**Figure 4. Distribution of Donation Amounts by Treatment Status**
![Distribution of Donation Amounts by Treatment Status](figures/fig4_donation_amount_distribution.png){#fig-donation-dist}
Donation amounts in both the control and treatment groups are right-skewed, with most contributions concentrated at lower values and a small number of large donations. Mean donation amounts are similar across groups ($45.54 for the control group and $43.87 for the treatment group).

```{python}
#| echo: false
# Filter to donors only
donors = df[df['gave'] == 1]
# Split by group
control_donors = donors[donors['treatment'] == 0]['amount']
treatment_donors = donors[donors['treatment'] == 1]['amount']
# Calculate means
control_mean = control_donors.mean()
treatment_mean = treatment_donors.mean()
# Create plots
fig, axs = plt.subplots(1, 2, figsize=(12, 5), sharey=True)

# Control histogram
axs[0].hist(control_donors, bins=30, color='skyblue', edgecolor='black')
axs[0].axvline(control_mean, color='red', linestyle='--', label=f'Mean = ${control_mean:.2f}')
axs[0].set_title("Control Group: Donation Amounts")
axs[0].set_xlabel("Donation Amount")
axs[0].set_ylabel("Frequency")
axs[0].legend()

# Treatment histogram
axs[1].hist(treatment_donors, bins=30, color='lightgreen', edgecolor='black')
axs[1].axvline(treatment_mean, color='red', linestyle='--', label=f'Mean = ${treatment_mean:.2f}')
axs[1].set_title("Treatment Group: Donation Amounts")
axs[1].set_xlabel("Donation Amount")
axs[1].legend()
plt.tight_layout()
plt.show()
``` 
------

**Figure 5. Sampling Distribution of Treatment–Control Differences (Simulated)**
![Sampling Distribution of Treatment–Control Differences (Simulated)](figures/fig5_sampling_dist_simulated.png){#fig-sampling-dist}
The figure shows the distribution of treatment–control differences in donation rates across 10,000 simulated experiments with 500 observations per group. The distribution is approximately normal and centered near 0.004, the difference implied by the assumed donation probabilities. The dashed line indicates the mean simulated difference, and the dotted line marks the null of no treatment effect.

```{python}
#| echo: false
import numpy as np
# Set simulation parameters
p_control = 0.018
p_treatment = 0.022
n = 500  # Sample size per group per iteration
iterations = 10000
np.random.seed(42)

# Store simulated differences
diffs = []

for _ in range(iterations):
    control_sample = np.random.binomial(1, p_control, size=n)
    treatment_sample = np.random.binomial(1, p_treatment, size=n)
    
    diff = treatment_sample.mean() - control_sample.mean()
    diffs.append(diff)

# Convert to array
diffs = np.array(diffs)

# Plot distribution of simulated differences
plt.figure(figsize=(10, 5))
plt.hist(diffs, bins=40, color='lightsteelblue', edgecolor='black')
plt.axvline(x=np.mean(diffs), color='red', linestyle='--', label=f'Mean Diff = {np.mean(diffs):.4f}')
plt.axvline(x=0, color='black', linestyle=':', label='Null (No Effect)')
plt.title('Sampling Distribution of Treatment-Control Differences (Simulated)')
plt.xlabel('Difference in Proportion Donating')
plt.ylabel('Frequency')
plt.legend()
plt.tight_layout()
plt.show()
```
------

### Law of Large Numbers

**Figure 6. Cumulative estimate of the treatment–control difference in mean donation amounts**

![](figures/fig6_cumulative_mean_difference.png)

Figure 6 plots the cumulative difference in mean donation amounts between the treatment and control groups as observations are added. When the sample size is small, the estimated difference fluctuates substantially. As the number of observations increases, the cumulative estimate stabilizes and converges toward the full-sample difference, illustrated by the horizontal dashed line.

```{python}
#| echo: false
# Sample real data without replacement
df_shuffled = df[['treatment', 'amount']].sample(frac=1, random_state=42).reset_index(drop=True)

# Encode treatment as +1 or -1 to compute difference
df_shuffled['diff'] = df_shuffled['amount'] * df_shuffled['treatment'] - df_shuffled['amount'] * (1 - df_shuffled['treatment'])

# Cumulative average difference (treatment - control contribution)
cumulative_avg = np.cumsum(df_shuffled['diff']) / np.arange(1, len(df_shuffled) + 1)

# True difference from earlier
true_diff = df[df['treatment'] == 1]['amount'].mean() - df[df['treatment'] == 0]['amount'].mean()

# Plot
plt.figure(figsize=(10, 5))
plt.plot(cumulative_avg, label='Cumulative Avg (Shuffled Real Data)')
plt.axhline(y=true_diff, color='red', linestyle='--', label=f'True Difference ≈ {true_diff:.4f}')
plt.title("Cumulative Average Difference")
plt.xlabel("Observation Index")
plt.ylabel("Cumulative Average Difference")
plt.legend()
plt.tight_layout()
plt.show()
```
------------


### Sampling Variability and Sample Size

**Figure 7. Sampling distributions of treatment–control differences by sample size**

![](figures/fig7_sampling_dist_by_sample_size.png)

Figure 7 shows simulated sampling distributions of treatment–control differences in donation rates for sample sizes of 50, 200, 500, and 1,000. With small samples, the distribution is wide. As sample size increases, the distributions concentrate around their mean, indicating greater precision.
```{python}
#| echo: false
import numpy as np
import matplotlib.pyplot as plt

# Set seed for reproducibility
np.random.seed(42)

# Use observed donation behavior (binary) from your dataset
p_control = 0.018  # Control group's donation probability
p_treatment = 0.022  # Treatment group's donation probability

# Sample sizes to simulate
sample_sizes = [50, 200, 500, 1000]
simulations = 1000  # Number of experiments per sample size

# Set up plot grid
fig, axs = plt.subplots(2, 2, figsize=(14, 10))
axs = axs.flatten()

# Run simulations and plot
for i, n in enumerate(sample_sizes):
    diffs = []
    for _ in range(simulations):
        control_sample = np.random.binomial(1, p_control, size=n)
        treatment_sample = np.random.binomial(1, p_treatment, size=n)
        diff = treatment_sample.mean() - control_sample.mean()
        diffs.append(diff)

    mean_diff = np.mean(diffs)
    
    # Plot histogram
    axs[i].hist(diffs, bins=30, color='lightblue', edgecolor='black')
    axs[i].axvline(x=0, color='red', linestyle='--', label='Zero')
    axs[i].axvline(x=mean_diff, color='green', linestyle='-', label='Mean')
    axs[i].set_title(f"Sample Size = {n}")
    axs[i].set_xlabel("Average Difference (Treatment − Control)")
    axs[i].set_ylabel("Frequency")
    axs[i].legend()

plt.tight_layout()
plt.show()
```